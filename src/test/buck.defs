yarn_prerequisites = {
    '.yarn': '//:yarn_dir',
    '.pnp.js': '//:yarn_pnp',
    '.yarnrc.yml': '//:yarn_rc',
    'yarn.lock': '//:yarn_lock',
}

def yarn(
    name,
    srcs = ['**'],
    srcs_exclude = ['BUCK', 'node_modules'],
    deps = []):

    all_srcs = yarn_prerequisites.copy()
    all_srcs.update({k:k for k in glob(srcs, exclude = srcs_exclude) + ['package.json']})

    genrule(
        name = 'pack',
        out = 'package.tgz',
        srcs = all_srcs,
        cmd = 'yarn pack --out "${OUT}"'
    )

    # what about zip_file()? instead of pack (tgz)?

def vue(
    name,
    srcs = ['**'],
    srcs_exclude = ['BUCK', 'node_modules'],
    deps = []):

    genrule(
        name = 'test',
        out = 'test.log',
        srcs = all_srcs,
        cmd = 'yarn test > ${OUT}',
    )

    genrule(
        name = 'lint',
        out = 'lint.log',
        srcs = all_srcs,
        cmd = 'yarn lint > ${OUT}',
    )

    genrule(
        name = 'build',
        out = 'dist',
        tests = [':lint', ':test'],
        srcs = all_srcs,
        cmd = 'exec >&2; set -x; ls -lA "${SRCDIR}"; mkdir "${OUT}"; CACHE_DIR="${TMP}" yarn build --dest "${OUT}"'
    )
